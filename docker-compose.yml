# ============================================
# Docker Compose: Local Development Setup
# ============================================
# Purpose: Run your API + MongoDB together locally
# Usage: docker-compose up

# ============================================
# SERVICES: The "containers" to run
# ============================================
services:
  # Service 1: Your API
  api:
    # Build from our Dockerfile
    build:
      context: .
      target: development
    
    container_name: knowledge-vault-api
    
    # Port mapping: host:container
    # Access at http://localhost:3000
    ports:
      - "3000:3000"
    
    # Environment variables
    environment:
      - NODE_ENV=${NODE_ENV}
      - MONGO_URI=${MONGO_URI}
      - JWT_SECRET=${JWT_SECRET}
      - SALT_ROUNDS=${SALT_ROUNDS}
    
    # Volumes: Sync code changes without rebuilding
    # Format: host_path:container_path
    volumes:
      # Your local src/ folder â†’ container's /app/src
      # Changes reflect immediately!
      - ./src:/app/src
      # Prevent local node_modules from overriding container's
      - /app/node_modules
    
    # Wait for MongoDB to start first
    depends_on:
      - mongo
    
    # Override the default CMD
    # Use nodemon for auto-restart on code changes
    command: npm run dev

  # Service 2: MongoDB
  mongo:
    # Use official MongoDB 7 image from Docker Hub
    image: mongo:7
    
    container_name: knowledge-vault-mongo
    
    # Expose MongoDB port
    ports:
      - "27017:27017"
    
    # Persist data even when container stops
    volumes:
      - mongo-data:/data/db
    
    # Initialize database
    environment:
      - MONGO_INITDB_DATABASE=knowledge-vault

# ============================================
# VOLUMES: Persistent storage
# ============================================
# Without this, data is lost when container stops!
volumes:
  mongo-data:
    # Docker manages this volume
    # Data survives container restarts
